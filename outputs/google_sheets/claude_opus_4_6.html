<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Sheets Clone</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Google Sans', Arial, sans-serif;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Top Header Bar */
  .header {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    height: 48px;
    border-bottom: 1px solid #e0e0e0;
    background: white;
  }

  .sheets-icon {
    width: 36px;
    height: 36px;
    margin-right: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sheets-icon svg {
    width: 32px;
    height: 32px;
  }

  .doc-title {
    font-size: 18px;
    color: #202124;
    padding: 2px 8px;
    border: 1px solid transparent;
    border-radius: 4px;
    cursor: text;
    outline: none;
    line-height: 24px;
  }

  .doc-title:hover {
    border-color: #dadce0;
  }

  .header-icons {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-left: 8px;
    color: #5f6368;
  }

  .header-icons span {
    cursor: pointer;
    font-size: 18px;
    padding: 4px;
    border-radius: 50%;
  }

  .header-icons span:hover {
    background: #f1f3f4;
  }

  .header-right {
    display: flex;
    align-items: center;
    margin-left: auto;
    gap: 12px;
  }

  .header-right-icons {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #5f6368;
  }

  .header-right-icons span {
    cursor: pointer;
    padding: 6px;
    border-radius: 50%;
    font-size: 20px;
  }

  .header-right-icons span:hover {
    background: #f1f3f4;
  }

  .share-btn {
    background: #c2e7ff;
    border: none;
    border-radius: 20px;
    padding: 8px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #001d35;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .share-btn:hover {
    background: #a8d8f0;
  }

  .share-btn .lock-icon {
    font-size: 16px;
  }

  .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #1a73e8;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
  }

  /* Menu Bar */
  .menu-bar {
    display: flex;
    align-items: center;
    padding: 2px 8px;
    height: 28px;
    background: white;
  }

  .menu-bar span {
    padding: 4px 8px;
    font-size: 14px;
    color: #202124;
    cursor: pointer;
    border-radius: 4px;
  }

  .menu-bar span:hover {
    background: #f1f3f4;
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    align-items: center;
    padding: 2px 8px;
    height: 40px;
    background: #edf2fa;
    border-radius: 24px;
    margin: 2px 8px;
    gap: 2px;
  }

  .toolbar-btn {
    padding: 4px 6px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #444746;
    font-size: 18px;
    border: none;
    background: transparent;
    min-width: 28px;
    height: 28px;
  }

  .toolbar-btn:hover {
    background: #d3dbe8;
  }

  .toolbar-separator {
    width: 1px;
    height: 20px;
    background: #c4c7c5;
    margin: 0 4px;
  }

  .toolbar-select {
    padding: 2px 4px;
    border: none;
    background: transparent;
    font-size: 13px;
    color: #444746;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 2px;
    height: 28px;
  }

  .toolbar-select:hover {
    background: #d3dbe8;
  }

  .zoom-select {
    font-size: 13px;
    min-width: 50px;
  }

  .font-select {
    min-width: 80px;
    font-size: 13px;
  }

  .font-size-group {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .font-size-input {
    width: 32px;
    height: 24px;
    border: 1px solid transparent;
    text-align: center;
    font-size: 13px;
    background: transparent;
    border-radius: 4px;
    color: #444746;
  }

  .font-size-input:focus {
    outline: none;
    border-color: #1a73e8;
  }

  .font-size-btn {
    font-size: 14px;
    padding: 2px 4px;
    min-width: 20px;
  }

  /* Formula Bar */
  .formula-bar {
    display: flex;
    align-items: center;
    height: 28px;
    border-bottom: 1px solid #e0e0e0;
    background: white;
  }

  .cell-ref {
    width: 80px;
    padding: 2px 8px;
    font-size: 13px;
    color: #202124;
    border-right: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    height: 100%;
    cursor: pointer;
  }

  .cell-ref-dropdown {
    margin-left: auto;
    font-size: 10px;
    color: #5f6368;
  }

  .fx-icon {
    padding: 0 8px;
    color: #5f6368;
    font-size: 14px;
    font-style: italic;
    font-weight: bold;
    display: flex;
    align-items: center;
  }

  .formula-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 13px;
    padding: 2px 8px;
    height: 100%;
    color: #202124;
  }

  /* Spreadsheet Grid */
  .spreadsheet-container {
    flex: 1;
    overflow: auto;
    position: relative;
    background: white;
  }

  .spreadsheet {
    border-collapse: collapse;
    table-layout: fixed;
  }

  .spreadsheet th {
    background: #f8f9fa;
    border: 1px solid #e2e3e3;
    font-weight: 400;
    font-size: 12px;
    color: #202124;
    position: sticky;
    z-index: 1;
    user-select: none;
  }

  .spreadsheet .col-header {
    top: 0;
    height: 24px;
    min-width: 100px;
    z-index: 2;
    border-top: none;
  }

  .spreadsheet .row-header {
    left: 0;
    width: 40px;
    min-width: 40px;
    max-width: 40px;
    text-align: center;
    z-index: 2;
    height: 25px;
  }

  .spreadsheet .corner-header {
    top: 0;
    left: 0;
    z-index: 3;
    width: 40px;
    min-width: 40px;
    background: #f8f9fa;
  }

  .spreadsheet td {
    border: 1px solid #e2e3e3;
    padding: 0 4px;
    font-size: 13px;
    color: #202124;
    height: 25px;
    min-width: 100px;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: cell;
    position: relative;
  }

  .spreadsheet td.selected {
    outline: 2px solid #1a73e8;
    outline-offset: -1px;
    z-index: 1;
  }

  .spreadsheet td.in-range {
    background: rgba(26, 115, 232, 0.08);
  }

  .spreadsheet .col-header.selected-header {
    background: #d3e3fd;
    color: #1a73e8;
    font-weight: 500;
  }

  .spreadsheet .row-header.selected-header {
    background: #d3e3fd;
    color: #1a73e8;
    font-weight: 500;
  }

  .cell-editor {
    position: absolute;
    display: none;
    z-index: 10;
    border: 2px solid #1a73e8;
    padding: 0 3px;
    font-size: 13px;
    font-family: Arial, sans-serif;
    outline: none;
    background: white;
    min-width: 100px;
    min-height: 25px;
    overflow: hidden;
    resize: none;
  }

  .resize-handle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: #1a73e8;
    border-radius: 50%;
    bottom: -3px;
    right: -3px;
    cursor: crosshair;
    z-index: 5;
    display: none;
  }

  .selected-cell-container .resize-handle {
    display: block;
  }

  /* Footer */
  .footer {
    display: flex;
    align-items: center;
    height: 36px;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
  }

  .add-sheet-btn {
    padding: 4px 10px;
    cursor: pointer;
    color: #5f6368;
    font-size: 20px;
    border: none;
    background: transparent;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 4px;
  }

  .add-sheet-btn:hover {
    background: #e8eaed;
  }

  .sheet-menu-btn {
    padding: 4px 10px;
    cursor: pointer;
    color: #5f6368;
    font-size: 18px;
    border: none;
    background: transparent;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sheet-menu-btn:hover {
    background: #e8eaed;
  }

  .sheet-tabs {
    display: flex;
    align-items: center;
    margin-left: 8px;
    flex: 1;
  }

  .sheet-tab {
    padding: 6px 16px;
    font-size: 13px;
    color: #202124;
    cursor: pointer;
    border-radius: 4px 4px 0 0;
    display: flex;
    align-items: center;
    gap: 6px;
    background: white;
    border: 1px solid #dadce0;
    border-bottom: none;
    font-weight: 500;
    position: relative;
    bottom: -1px;
  }

  .sheet-tab.active {
    background: white;
    border-bottom: 2px solid white;
  }

  .sheet-tab .dropdown-arrow {
    font-size: 10px;
    color: #5f6368;
  }

  /* Scrollbar styling */
  .spreadsheet-container::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  .spreadsheet-container::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .spreadsheet-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 6px;
    border: 3px solid #f1f1f1;
  }

  .spreadsheet-container::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
  }

  .spreadsheet-container::-webkit-scrollbar-corner {
    background: #f1f1f1;
  }

  .toolbar-text-btn {
    font-size: 14px;
    font-weight: 500;
    padding: 4px 8px;
  }

  .bold-btn { font-weight: 700; }
  .italic-btn { font-style: italic; }

  .collapse-btn {
    margin-left: auto;
    font-size: 18px;
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="sheets-icon">
    <svg viewBox="0 0 48 48" width="32" height="32">
      <path fill="#43a047" d="M37,45H11c-1.657,0-3-1.343-3-3V6c0-1.657,1.343-3,3-3h19l10,10v29C40,43.657,38.657,45,37,45z"/>
      <path fill="#c8e6c9" d="M40,13H30V3L40,13z"/>
      <path fill="#2e7d32" d="M30,13l10,0V13L30,3V13z"/>
      <g fill="#fff">
        <rect x="15" y="19" width="18" height="3"/>
        <rect x="15" y="25" width="18" height="3"/>
        <rect x="15" y="31" width="18" height="3"/>
        <rect x="15" y="19" width="3" height="15"/>
        <rect x="24" y="19" width="3" height="15"/>
      </g>
    </svg>
  </div>
  <div style="display: flex; flex-direction: column;">
    <div style="display: flex; align-items: center; gap: 4px;">
      <input class="doc-title" value="Untitled spreadsheet" spellcheck="false">
      <div class="header-icons">
        <span title="Star">‚òÜ</span>
        <span title="Move">üìÅ</span>
        <span title="Cloud">‚òÅ</span>
      </div>
    </div>
  </div>
  <div class="header-right">
    <div class="header-right-icons">
      <span title="History">üïê</span>
      <span title="Comments">üí¨</span>
      <span title="Meet">üé•</span>
    </div>
    <button class="share-btn">
      <span class="lock-icon">üîí</span>
      Share
    </button>
    <div class="user-avatar">U</div>
  </div>
</div>

<!-- Menu Bar -->
<div class="menu-bar">
  <span>File</span>
  <span>Edit</span>
  <span>View</span>
  <span>Insert</span>
  <span>Format</span>
  <span>Data</span>
  <span>Tools</span>
  <span>Extensions</span>
  <span>Help</span>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <button class="toolbar-btn" title="Search">üîç</button>
  <button class="toolbar-btn" title="Undo">‚Ü©</button>
  <button class="toolbar-btn" title="Redo">‚Ü™</button>
  <button class="toolbar-btn" title="Print">üñ®</button>
  <button class="toolbar-btn" title="Format as paint">üé®</button>
  <div class="toolbar-separator"></div>
  <button class="toolbar-select zoom-select">100% ‚ñæ</button>
  <div class="toolbar-separator"></div>
  <button class="toolbar-btn toolbar-text-btn" title="Currency">¬£</button>
  <button class="toolbar-btn toolbar-text-btn" title="Percent">%</button>
  <button class="toolbar-btn toolbar-text-btn" title="Decrease decimal">.0</button>
  <button class="toolbar-btn toolbar-text-btn" title="Increase decimal">.00</button>
  <button class="toolbar-btn toolbar-text-btn" title="123">123</button>
  <div class="toolbar-separator"></div>
  <button class="toolbar-select font-select">Arial ‚ñæ</button>
  <div class="toolbar-separator"></div>
  <div class="font-size-group">
    <button class="toolbar-btn font-size-btn">‚àí</button>
    <input class="font-size-input" value="10" id="fontSizeInput">
    <button class="toolbar-btn font-size-btn">+</button>
  </div>
  <div class="toolbar-separator"></div>
  <button class="toolbar-btn bold-btn" title="Bold"><b>B</b></button>
  <button class="toolbar-btn italic-btn" title="Italic"><i>I</i></button>
  <button class="toolbar-btn" title="Strikethrough"><s>S</s></button>
  <button class="toolbar-btn" title="Text color">A<span style="display:block;height:3px;width:14px;background:#000;margin-top:-2px;"></span></button>
  <button class="toolbar-btn" title="Fill color">ü™£</button>
  <div class="toolbar-separator"></div>
  <button class="toolbar-btn" title="Borders">‚äû</button>
  <button class="toolbar-btn" title="Merge">‚äü</button>
  <div class="toolbar-separator"></div>
  <button class="toolbar-btn" title="More">‚ãÆ</button>
  <button class="toolbar-btn collapse-btn" title="Collapse">‚àß</button>
</div>

<!-- Formula Bar -->
<div class="formula-bar">
  <div class="cell-ref">
    <span id="cellRef">A1</span>
    <span class="cell-ref-dropdown" style="margin-left:auto;">‚ñæ</span>
  </div>
  <div class="fx-icon">fx</div>
  <input class="formula-input" id="formulaInput" type="text">
</div>

<!-- Spreadsheet -->
<div class="spreadsheet-container" id="spreadsheetContainer">
  <table class="spreadsheet" id="spreadsheet">
    <thead>
      <tr id="headerRow">
        <th class="col-header corner-header"></th>
      </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
  </table>
  <textarea class="cell-editor" id="cellEditor"></textarea>
</div>

<!-- Footer -->
<div class="footer">
  <button class="add-sheet-btn" title="Add sheet">+</button>
  <button class="sheet-menu-btn" title="All sheets">‚ò∞</button>
  <div class="sheet-tabs">
    <div class="sheet-tab active">
      Sheet1
      <span class="dropdown-arrow">‚ñæ</span>
    </div>
  </div>
</div>

<script>
const NUM_ROWS = 50;
const NUM_COLS = 26;
const COL_WIDTH = 100;
const ROW_HEIGHT = 25;

// Data storage
const cellData = {};
let selectedCell = { row: 1, col: 1 };
let isEditing = false;
let selectionStart = null;
let selectionEnd = null;
let isSelecting = false;

function getColLetter(col) {
  let s = '';
  while (col > 0) {
    col--;
    s = String.fromCharCode(65 + (col % 26)) + s;
    col = Math.floor(col / 26);
  }
  return s;
}

function getCellId(row, col) {
  return getColLetter(col) + row;
}

// Build table
function buildTable() {
  const headerRow = document.getElementById('headerRow');
  const tableBody = document.getElementById('tableBody');

  // Add column headers
  for (let c = 1; c <= NUM_COLS; c++) {
    const th = document.createElement('th');
    th.className = 'col-header';
    th.textContent = getColLetter(c);
    th.dataset.col = c;
    th.style.width = COL_WIDTH + 'px';
    headerRow.appendChild(th);
  }

  // Add rows
  for (let r = 1; r <= NUM_ROWS; r++) {
    const tr = document.createElement('tr');
    const rowHeader = document.createElement('th');
    rowHeader.className = 'row-header';
    rowHeader.textContent = r;
    rowHeader.dataset.row = r;
    tr.appendChild(rowHeader);

    for (let c = 1; c <= NUM_COLS; c++) {
      const td = document.createElement('td');
      td.dataset.row = r;
      td.dataset.col = c;
      td.id = 'cell-' + r + '-' + c;
      tr.appendChild(td);
    }
    tableBody.appendChild(tr);
  }
}

function selectCell(row, col, editMode = false) {
  // Clear previous selection
  clearSelection();
  
  selectedCell = { row, col };
  selectionStart = { row, col };
  selectionEnd = { row, col };

  const cell = document.getElementById('cell-' + row + '-' + col);
  if (cell) {
    cell.classList.add('selected');
  }

  // Update headers
  updateHeaders();

  // Update cell reference
  document.getElementById('cellRef').textContent = getCellId(row, col);

  // Update formula bar
  const cellId = getCellId(row, col);
  const data = cellData[cellId];
  document.getElementById('formulaInput').value = data ? (data.formula || data.value || '') : '';

  if (editMode) {
    startEditing(row, col);
  }
}

function clearSelection() {
  document.querySelectorAll('.spreadsheet td.selected').forEach(el => el.classList.remove('selected'));
  document.querySelectorAll('.spreadsheet td.in-range').forEach(el => el.classList.remove('in-range'));
  document.querySelectorAll('.col-header.selected-header').forEach(el => el.classList.remove('selected-header'));
  document.querySelectorAll('.row-header.selected-header').forEach(el => el.classList.remove('selected-header'));
}

function updateHeaders() {
  document.querySelectorAll('.col-header.selected-header').forEach(el => el.classList.remove('selected-header'));
  document.querySelectorAll('.row-header.selected-header').forEach(el => el.classList.remove('selected-header'));

  const minCol = Math.min(selectionStart.col, selectionEnd.col);
  const maxCol = Math.max(selectionStart.col, selectionEnd.col);
  const minRow = Math.min(selectionStart.row, selectionEnd.row);
  const maxRow = Math.max(selectionStart.row, selectionEnd.row);

  for (let c = minCol; c <= maxCol; c++) {
    const header = document.querySelector(`.col-header[data-col="${c}"]`);
    if (header) header.classList.add('selected-header');
  }
  for (let r = minRow; r <= maxRow; r++) {
    const header = document.querySelector(`.row-header[data-row="${r}"]`);
    if (header) header.classList.add('selected-header');
  }
}

function updateRangeSelection() {
  document.querySelectorAll('.spreadsheet td.in-range').forEach(el => el.classList.remove('in-range'));
  document.querySelectorAll('.spreadsheet td.selected').forEach(el => el.classList.remove('selected'));

  const minCol = Math.min(selectionStart.col, selectionEnd.col);
  const maxCol = Math.max(selectionStart.col, selectionEnd.col);
  const minRow = Math.min(selectionStart.row, selectionEnd.row);
  const maxRow = Math.max(selectionStart.row, selectionEnd.row);

  for (let r = minRow; r <= maxRow; r++) {
    for (let c = minCol; c <= maxCol; c++) {
      const cell = document.getElementById('cell-' + r + '-' + c);
      if (cell) {
        if (r === selectedCell.row && c === selectedCell.col) {
          cell.classList.add('selected');
        } else {
          cell.classList.add('in-range');
        }
      }
    }
  }

  updateHeaders();
}

function startEditing(row, col) {
  isEditing = true;
  const cell = document.getElementById('cell-' + row + '-' + col);
  const editor = document.getElementById('cellEditor');
  const container = document.getElementById('spreadsheetContainer');

  const cellRect = cell.getBoundingClientRect();
  const containerRect = container.getBoundingClientRect();

  editor.style.display = 'block';
  editor.style.left = (cellRect.left - containerRect.left + container.scrollLeft) + 'px';
  editor.style.top = (cellRect.top - containerRect.top + container.scrollTop) + 'px';
  editor.style.width = cellRect.width + 'px';
  editor.style.height = cellRect.height + 'px';

  const cellId = getCellId(row, col);
  const data = cellData[cellId];
  editor.value = data ? (data.formula || data.value || '') : '';
  editor.focus();
}

function stopEditing() {
  if (!isEditing) return;
  isEditing = false;

  const editor = document.getElementById('cellEditor');
  const value = editor.value;
  editor.style.display = 'none';

  const cellId = getCellId(selectedCell.row, selectedCell.col);
  
  if (value) {
    if (value.startsWith('=')) {
      const result = evaluateFormula(value);
      cellData[cellId] = { value: result, formula: value };
    } else {
      cellData[cellId] = { value: value, formula: null };
    }
  } else {
    delete cellData[cellId];
  }

  renderCell(selectedCell.row, selectedCell.col);
  document.getElementById('formulaInput').value = value || '';
}

function evaluateFormula(formula) {
  try {
    let expr = formula.substring(1);
    
    // Replace cell references with values
    expr = expr.replace(/([A-Z]+)(\d+)/gi, (match, col, row) => {
      const cellId = col.toUpperCase() + row;
      const data = cellData[cellId];
      if (data) {
        const num = parseFloat(data.value);
        return isNaN(num) ? 0 : num;
      }
      return 0;
    });

    // Handle SUM
    expr = expr.replace(/SUM\(([^)]+)\)/gi, (match, args) => {
      const parts = args.split(',');
      let sum = 0;
      parts.forEach(part => {
        if (part.includes(':')) {
          const [start, end] = part.trim().split(':');
          const startMatch = start.match(/([A-Z]+)(\d+)/i);
          const endMatch = end.match(/([A-Z]+)(\d+)/i);
          if (startMatch && endMatch) {
            const sc = startMatch[1].toUpperCase().charCodeAt(0) - 64;
            const sr = parseInt(startMatch[2]);
            const ec = endMatch[1].toUpperCase().charCodeAt(0) - 64;
            const er = parseInt(endMatch[2]);
            for (let r = sr; r <= er; r++) {
              for (let c = sc; c <= ec; c++) {
                const id = getColLetter(c) + r;
                const d = cellData[id];
                if (d) sum += parseFloat(d.value) || 0;
              }
            }
          }
        } else {
          sum += parseFloat(part) || 0;
        }
      });
      return sum;
    });

    return eval(expr);
  } catch (e) {
    return '#ERROR';
  }
}

function renderCell(row, col) {
  const cell = document.getElementById('cell-' + row + '-' + col);
  const cellId = getCellId(row, col);
  const data = cellData[cellId];
  cell.textContent = data ? data.value : '';
}

// Event Listeners
document.getElementById('spreadsheet').addEventListener('mousedown', function(e) {
  const td = e.target.closest('td');
  if (!td) return;

  const row = parseInt(td.dataset.row);
  const col = parseInt(td.dataset.col);

  if (isEditing) {
    stopEditing();
  }

  selectCell(row, col);
  isSelecting = true;
  selectionStart = { row, col };
  selectionEnd = { row, col };
});

document.addEventListener('mousemove', function(e) {
  if (!isSelecting) return;
  const td = e.target.closest('td');
  if (!td) return;

  const row = parseInt(td.dataset.row);
  const col = parseInt(td.dataset.col);

  if (row && col) {
    selectionEnd = { row, col };
    updateRangeSelection();
  }
});

document.addEventListener('mouseup', function() {
  isSelecting = false;
});

document.getElementById('spreadsheet').addEventListener('dblclick', function(e) {
  const td = e.target.closest('td');
  if (!td) return;
  const row = parseInt(td.dataset.row);
  const col = parseInt(td.dataset.col);
  selectCell(row, col, true);
});

document.addEventListener('keydown', function(e) {
  if (isEditing) {
    if (e.key === 'Enter') {
      e.preventDefault();
      stopEditing();
      if (selectedCell.row < NUM_ROWS) {
        selectCell(selectedCell.row + 1, selectedCell.col);
      }
    } else if (e.key === 'Escape') {
      isEditing = false;
      document.getElementById('cellEditor').style.display = 'none';
    } else if (e.key === 'Tab') {
      e.preventDefault();
      stopEditing();
      if (selectedCell.col < NUM_COLS) {
        selectCell(selectedCell.row, selectedCell.col + 1);
      }
    }
    return;
  }

  if (e.key === 'Enter') {
    e.preventDefault();
    startEditing(selectedCell.row, selectedCell.col);
  } else if (e.key === 'Tab') {
    e.preventDefault();
    if (selectedCell.col < NUM_COLS) {
      selectCell(selectedCell.row, selectedCell.col + (e.shiftKey ? -1 : 1));
    }
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (selectedCell.row < NUM_ROWS) selectCell(selectedCell.row + 1, selectedCell.col);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (selectedCell.row > 1) selectCell(selectedCell.row - 1, selectedCell.col);
  } else if (e.key === 'ArrowRight') {
    e.preventDefault();
    if (selectedCell.col < NUM_COLS) selectCell(selectedCell.row, selectedCell.col + 1);
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    if (selectedCell.col > 1) selectCell(selectedCell.row, selectedCell.col - 1);
  } else if (e.key === 'Delete' || e.key === 'Backspace') {
    const cellId = getCellId(selectedCell.row, selectedCell.col);
    delete cellData[cellId];
    renderCell(selectedCell.row, selectedCell.col);
    document.getElementById('formulaInput').value = '';
  } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
    startEditing(selectedCell.row, selectedCell.col);
    const editor = document.getElementById('cellEditor');
    editor.value = e.key;
  }
});

// Formula bar input
document.getElementById('formulaInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const cellId = getCellId(selectedCell.row, selectedCell.col);
    const value = this.value;
    if (value) {
      if (value.startsWith('=')) {
        const result = evaluateFormula(value);
        cellData[cellId] = { value: result, formula: value };
      } else {
        cellData[cellId] = { value: value, formula: null };
      }
    } else {
      delete cellData[cellId];
    }
    renderCell(selectedCell.row, selectedCell.col);
    document.getElementById('spreadsheetContainer').focus();
  }
});

document.getElementById('formulaInput').addEventListener('focus', function() {
  const cellId = getCellId(selectedCell.row, selectedCell.col);
  const data = cellData[cellId];
  this.value = data ? (data.formula || data.value || '') : '';
});

// Cell editor input sync
document.getElementById('cellEditor').addEventListener('input', function() {
  document.getElementById('formulaInput').value = this.value;
});

// Build and initialize
buildTable();
selectCell(1, 1);
</script>

</body>
</html>